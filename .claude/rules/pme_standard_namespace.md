# PME Standard Namespace

## 目的

このドキュメントは、`pme.execute()` / `pme.evaluate()` で自動的に提供される**標準名前空間**を定義します。

外部ツール（Gizmo Creator など）がこの名前空間に依存できるよう、各変数の**名前・意味・約束の範囲**を明確にします。

---

## 重要な前提

### v2.0.0 では全て Experimental

**v2.0.0 の時点では、標準名前空間の全ての変数は Experimental です。**

Stable ラベルは v2.1.0 以降で、利用実績を見て付与します。
今の段階で Stable を付けると、将来のリファクタの自由度を失います。

### 約束の範囲

PME が約束するのは以下の範囲に限定されます：

- **「この名前で、Blender 文脈で reasonable なものを渡す」**
- 中身の exact type / ラッパー構造までは固定しない

例えば `C` について：
- ✅ 約束する: 「`C` という名前で Blender コンテキストに相当する何かを渡す」
- ❌ 約束しない: 「`C` は必ず `bpy.context` そのものである」

---

## 概要

PME の実行エンジンは、ユーザーが書いた Python コードを評価する際に、以下の変数を自動的に名前空間に注入します。
これにより、ユーザーは `import` なしで Blender API にアクセスできます。

### 実装箇所

標準名前空間は以下の箇所で構築されます：

1. `PMEContext.__init__()` — 初期グローバル変数の設定
2. `PMEContext.event` setter — `E`, `delta` の設定
3. `PMEContext.layout` setter — `L` の設定
4. `PMEContext.gen_globals()` — 最終的なグローバル辞書の生成
5. `pme.register()` — `U` (UserData) の登録

---

## 変数一覧

> **注意**: 実際のグローバル名前空間には **70 以上の変数** が存在します。
> 外部ツールが依存してよいのは、ごく一部の「公開候補」のみです。

### 公開候補（Experimental）

外部ツールからの利用を想定している変数。v2.0.0 では全て Experimental。

#### Core（Blender API ショートカット）

| 変数名 | 意味 | 登録箇所 |
|--------|------|---------|
| `bpy` | Blender Python モジュール | `pme.py`, `bl_utils.py` |
| `C` | Blender コンテキスト | `bl_utils.py` |
| `D` | `bpy.data` | `__init__.py` |

#### Event（イベント情報）

| 変数名 | 意味 | 登録箇所 |
|--------|------|---------|
| `E` | 現在のイベント | `pme.py` (event setter) |
| `delta` | マウスホイールのデルタ値 (1, -1, 0) | `pme.py` (event setter) |
| `drag_x`, `drag_y` | ドラッグ移動量 | `operators/__init__.py` |

#### User

| 変数名 | 意味 | 登録箇所 |
|--------|------|---------|
| `U` | ユーザーデータ（セッション内のみ） | `pme.py` (register) |

### Internal（依存禁止）

以下は PME 内部でユーザースクリプトに便利機能を提供するために存在しますが、**外部ツールからの依存は禁止**です。予告なく変更・削除されます。

#### Blender API ショートカット（Internal）

| 変数名 | 内容 | 登録箇所 |
|--------|------|---------|
| `T` | `bpy.types` | `__init__.py` |
| `O` | `bpy.ops` | `__init__.py` |
| `P` | `bpy.props` | `__init__.py` |
| `sys` | `sys` モジュール | `__init__.py` |
| `os` | `os` モジュール | `preferences.py` |
| `re` | `re` モジュール | `bl_utils.py` |
| `traceback` | `traceback` モジュール | `operators/__init__.py` |
| `BoolProperty`, `IntProperty`, `FloatProperty`, ... | `bpy.props.*` | `__init__.py` |

#### PME 内部機能（Internal）

| 変数名 | 内容 | 登録箇所 |
|--------|------|---------|
| `pme_context` | `PMEContext` インスタンス | `pme.py` |
| `pme` | `pme` モジュール | `preferences.py` |
| `prefs`, `_prefs`, `get_prefs`, `temp_prefs` | 設定アクセス | `preferences.py` |
| `context`, `bl_context` | コンテキストラッパー | `bl_utils.py` |
| `L` | 現在のレイアウト | `pme.py` (layout setter) |

#### UI ヘルパー（Internal）

| 変数名 | 内容 | 登録箇所 |
|--------|------|---------|
| `message_box`, `input_box`, `close_popups` | ダイアログ関数 | `bl_utils.py` |
| `overlay` | オーバーレイ描画 | `overlay.py` |
| `tag_redraw`, `panel`, `focus_area`, ... | UI 操作 | 各モジュール |
| `custom_icon` | カスタムアイコン取得 | `previews_helper.py` |
| `lh` | LayoutHelper | 不明 |

#### 実行ヘルパー（Internal）

| 変数名 | 内容 | 登録箇所 |
|--------|------|---------|
| `SK` | StackKey クラス | `keymap_helper.py` |
| `call_operator` | オペレーター呼び出し | `keymap_helper.py` |
| `find_by` | コレクション検索 | `infra/collections.py` |
| `keep_pie_open` | Pie を開いたままにする | `c_utils.py` |
| `override_context`, `exec_with_override` | コンテキストオーバーライド | 各モジュール |

#### ペイント関連（Internal）

| 変数名 | 内容 | 登録箇所 |
|--------|------|---------|
| `paint_settings`, `unified_paint_panel` | ペイント設定 | `bl_utils.py` |
| `ups` | 統合ペイント設定を取得する関数 | `scripts/autorun/functions.py` |
| `brush` | ブラシ設定を取得する関数 | `scripts/autorun/functions.py` |

#### Autorun スクリプトから登録される関数（Internal）

> `scripts/autorun/functions.py` から `pme.context.add_global()` で登録される関数群。
> ファイルには「Do NOT edit this file. All changes will be lost」とあり、自動生成の可能性がある。

| 変数名 | 内容 | 説明 |
|--------|------|------|
| `setattr` | `setattr()` ラッパー | 標準 `setattr` と同じだが `True` を返す |
| `try_setattr` | 安全な属性設定 | 例外を無視する `setattr` |
| `event_mods` | 修飾キー取得 | `"Ctrl+Shift"` のような文字列を返す |
| `raise_error` | エラー表示 | メッセージボックス表示後に例外を投げる |

#### その他（Internal）

| 変数名 | 内容 |
|--------|------|
| `PMEData` | PME データクラス |
| `text`, `icon`, `icon_value` | 現在のアイテム情報 |
| `header_menu`, `draw_menu`, `open_menu`, ... | メニュー操作 |
| `__name__`, `__file__`, `__builtins__`, ... | Python 内部変数 |

---

## Stability Levels

### Experimental（v2.0.0 の全変数）

- v2.0.0 時点では暫定仕様
- 型や挙動が変わる可能性がある
- v2.1.0 以降で、利用実績を見て Stable に昇格するものを決める
- 外部ツールからの利用は可能だが、変更リスクを理解した上で

### Internal

- 外部からの利用は非推奨
- 予告なく変更・削除される可能性がある
- 内部実装の都合で存在している

---

## 外部ツールへのガイダンス

### 推奨される依存パターン

```python
# Gizmo Creator の例
from pie_menu_editor import pme

class GizmoAction:
    script: str  # ユーザーが設定した Python コード

    def execute(self, context, event):
        result = pme.execute(
            self.script,
            extra_globals={
                "gizmo": self,                    # Gizmo 固有の変数
                "gesture_direction": self.dir,   # ジェスチャー情報
            }
        )
        # スクリプト内では以下が使える:
        # - C, D, bpy: Blender API（Stable）
        # - gizmo, gesture_direction: Gizmo が渡した変数
        # - E, delta: イベント情報（あれば）
```

### 依存してよい変数

1. **`C`, `D`, `bpy`** — 常に安全に依存可能
2. **`extra_globals` で渡した変数** — 自分で渡したもの

### 依存に注意が必要な変数

1. **`E`, `delta`, `drag_x`, `drag_y`** — イベントコンテキストがないと `None` / `0`
2. **`L`** — UI 描画コンテキストがないと `None`
3. **`U`** — セッション内のみ有効。Blender 再起動でリセット

### 依存すべきでない変数

1. **`pme_context`** — 内部実装
2. **`PME`, `PREFS`** — 内部設定への直接アクセス

---

## `UserData` (`U`) の詳細

### 現状の挙動

- **セッション内のみ有効**: Blender を再起動するとデータは失われる
- **任意の属性を設定可能**: `U.my_value = 42` のように使える
- **`get()` メソッド**: デフォルト値付きで取得 `U.get("my_value", 0)`
- **`update()` メソッド**: 複数の属性を一括設定 `U.update(a=1, b=2)`

### 実装

```python
class UserData:
    def get(self, name, default=None):
        return self.__dict__.get(name, default)

    def update(self, **kwargs):
        self.__dict__.update(**kwargs)

    def __getattr__(self, name):
        return self.__dict__.get(name, None)
```

### 将来の方向性

Phase 3 で永続化 API (`pme.user_data.get/set`) を検討する際、`U` との関係を整理する必要がある。

候補案：
1. `U` は引き続きセッション内のみ、`pme.user_data` が永続化を担当
2. `U` を永続化対応にアップグレード（互換性リスク）

---

## バージョン間の互換性方針

### v2.0.0 時点

| 変数 | 方針 |
|------|------|
| `C`, `D`, `bpy` | 変更なし |
| `E`, `delta`, `drag_x`, `drag_y` | 型と基本的な意味は維持。詳細な挙動は調整の可能性あり |
| `L` | 型は維持。描画コンテキスト外での挙動は未定義 |
| `U` | インターフェースは維持。永続化は Phase 3 で検討 |
| `text`, `icon`, `icon_value` | PM/PMI 実行時のみ設定。それ以外は `None` |
| `pme_context`, `PME`, `PREFS` | Internal。外部からの依存は非推奨 |

### v2.x 系での約束

- **Stable 変数**（`C`, `D`, `bpy`）は変更しない
- **Experimental 変数** の変更時は、可能な限り事前通知する
- **Internal 変数** は予告なく変更される可能性がある

---

## 参照

- `pme.py`: `PMEContext.__init__`, `gen_globals()` の実装
- `rules/pme_api_plan.md`: API 設計案
- `rules/pme_api_current.md`: 現状のインベントリ
